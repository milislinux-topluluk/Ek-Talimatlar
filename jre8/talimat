# Tanım: Oracle Java 8 Çalışma Zamanı Ortamı
# URL: http://www.oracle.com/technetwork/java/javase/downloads/index.html
# Paketçi: Cihan Alkan
# Gerekler: ca-certificates-utils hicolor-icon-theme java-runtime-common nss xdg-utils

isim=jre8
surum=1.8.152
devir=1
install=jre8.install
kaynak=(http://download.oracle.com/otn-pub/java/jdk/8u152-b16/aa0333dd3019491ca4f6ddbe78cdb6d0/jre-8u152-linux-x64.tar.gz
        http://download.oracle.com/otn-pub/java/jce/8/jce_policy-8.zip
        policytool-jre8.desktop)

provides=("java-runtime=8" "java-runtime-headless=8" "java-web-start=8"
          "java-runtime-jre=8" "java-runtime-headless-jre=8" "java-web-start-jre=8"
          "java-openjfx=8")
DLAGENTS=('http::/usr/bin/curl -fLC - --retry 3 --retry-delay 3 -b oraclelicense=a -o %o %u')

derle() {  
    cd jre1.8.0_152

    install -d "$PKG"/etc/.java/.systemPrefs
    install -d "$PKG"/usr/lib/jvm/java-8-jre/jre/bin
    install -d "$PKG"/usr/lib/mozilla/plugins
    install -d "$PKG"/usr/share/licenses/java8-jre

    rm -r lib/desktop/icons/HighContrast/
    rm -r lib/desktop/icons/HighContrastInverse/
    rm -r lib/desktop/icons/LowContrast/
    rm    lib/fontconfig.*.bfc
    rm    lib/fontconfig.*.properties.src
    rm    man/ja
    rm -r plugin/

    mv * "$PKG"//usr/lib/jvm/java-8-jre/jre

    # Cd to the new playground
    cd "$PKG"//usr/lib/jvm/java-8-jre/jre

    # Suffix .desktops + icons (sun-java.png -> sun-java-jre8.png)
    for i in $(find lib/desktop/ -type f); do
        rename -- "." "-jre8." $i
    done

    # Fix .desktop paths
    sed -e "s|Exec=|Exec=/usr/lib/jvm/java-8-jre/jre/bin/|" \
        -e "s|.png|-jre8.png|" \
    -i lib/desktop/applications/*

    # Move .desktops + icons to /usr/share
    mv lib/desktop/* "$PKG"/usr/share/
    install -m644 "$SRC"/*.desktop "$PKG"/usr/share/applications/

    # Move confs to /etc and link back to /usr: /usr/lib/jvm/java-jre8/lib -> /etc
    for new_etc_path in ${backup[@]}; do
        # Old location
        old_usr_path="lib/${new_etc_path#*jre8/}"

        # Move
        install -Dm644 "$old_usr_path" "$PKG/$new_etc_path"
        ln -sf "/$new_etc_path" "$old_usr_path"
    done

    # Link NPAPI plugin
    ln -sf /usr/lib/jvm/java-8-jre/jre/lib/amd64/libnpjp2.so "$PKG"/usr/lib/mozilla/plugins/libnpjp2-jre8.so

    # Replace JKS keystore with 'ca-certificates-java'
    ln -sf /etc/ssl/certs/java/cacerts lib/security/cacerts

    # Suffix man pages
    for i in $(find man/ -type f); do
        mv "$i" "${i/.1}-jre8.1"
    done

    # Move man pages
    mv man/ja_JP.UTF-8/ man/ja
    mv man/ "$PKG"/usr/share

    # Move/link licenses
    mv COPYRIGHT LICENSE README *.txt "$PKG"/usr/share/licenses/java8-jre/
    ln -sf /usr/share/licenses/java8-jre/ "$PKG"/usr/share/licenses/jre8

    # Replace default "strong", but limited, cryptography to get an "unlimited strength" one for
    # things like 256-bit AES. Enabled by default in OpenJDK:
    # - http://suhothayan.blogspot.com/2012/05/how-to-install-java-cryptography.html
    # - http://www.eyrie.org/~eagle/notes/debian/jce-policy.html
    install -m644 "$SRC"/UnlimitedJCEPolicyJDK8/*.jar lib/security/
    install -Dm644 "$SRC"/UnlimitedJCEPolicyJDK8/README.txt \
                   "$PKG"/usr/share/doc/jre/README_-_Java_JCE_Unlimited_Strength.txt

    # Copy/paste from system clipboard to unsigned Java applets has been disabled since 6u24:
    # - https://blogs.oracle.com/kyle/entry/copy_and_paste_in_java
    # - http://slightlyrandombrokenthoughts.blogspot.com/2011/03/oracle-java-applet-clipboard-injection.html
#    _line=$(awk '/permission/{a=NR}; END{print a}' "$PKG"/etc/java-jre8/security/java.policy)
 #   sed "$_line a\\\\n \
 #       // (AUR) Allow unsigned applets to read system clipboard, see:\n \
 #       // - https://blogs.oracle.com/kyle/entry/copy_and_paste_in_java\n \
 #       // - http://slightlyrandombrokenthoughts.blogspot.com/2011/03/oracle-java-applet-clipboard-injection.html\n \
 #       permission java.awt.AWTPermission \"accessClipboard\";" \
 #   -i "$PKG"/etc/java-jre8/security/java.policy
}
